name: API Lint

on:
  pull_request:
    paths:
      - 'protos/**/*.proto'
      - 'buf.yaml'
      - 'buf.gen.yaml'
  push:
    branches: [ main ]
    paths:
      - 'protos/**/*.proto'
      - 'buf.yaml'
      - 'buf.gen.yaml'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ github.token }}

      - name: buf format
        run: buf format --diff --exit-code

  #    - name: buf lint
  #      run: buf lint

  # - name: Install Google API Linter
  #   run: |
  #     set -euxo pipefail
  #     LINTER_VERSION=1.70.2
  #     curl -sSL -o api-linter.tar.gz \
  #       https://github.com/googleapis/api-linter/releases/download/v${LINTER_VERSION}/api-linter-linux-amd64-${LINTER_VERSION}.tar.gz
  #     tar -xzf api-linter.tar.gz
  #     sudo mv api-linter /usr/local/bin/api-linter
  #     api-linter --version

  # - name: Build descriptor set
  #   run: |
  #     buf build -o /tmp/mplang-descriptors.binpb

  # - name: Google API Linter (AIP rules)
  #   run: |
  #     set -euxo pipefail
  #     proto_files=$(git ls-files 'protos/**/*.proto')
  #     if [ -z "$proto_files" ]; then
  #       echo "No protos found"; exit 0; fi
  #     api-linter --set-exit-status --output-format text \
  #       --descriptor-set-in /tmp/mplang-descriptors.binpb \
  #       $proto_files

      - name: buf breaking
        if: github.event_name == 'pull_request'
        run: buf breaking --against '.git#branch=main'
