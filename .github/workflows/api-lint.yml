name: API Lint

on:
  pull_request:
    paths:
      - 'protos/**/*.proto'
      - 'buf.yaml'
      - 'buf.gen.yaml'
  push:
    branches: [ main ]
    paths:
      - 'protos/**/*.proto'
      - 'buf.yaml'
      - 'buf.gen.yaml'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1

      - name: buf format
        run: buf format --diff --exit-code

      - name: buf lint
        id: buf_lint
        run: buf lint
        continue-on-error: true

      - name: setup go
        uses: actions/setup-go@v6
        with:
          go-version: 1.23

      - name: Install Google API Linter
        run: |
          set -euxo pipefail
          go install github.com/googleapis/api-linter/cmd/api-linter@latest
          api-linter --version

      - name: Build descriptor set
        run: |
          buf build -o /tmp/mplang-descriptors.binpb

      - name: Google API Linter (AIP rules)
        id: api_linter
        continue-on-error: true
        run: |
          set -euxo pipefail
          proto_files=$(git ls-files 'protos/**/*.proto')
          if [ -z "$proto_files" ]; then
            echo "No protos found"; exit 0; fi
          api-linter --set-exit-status --output-format text \
            --descriptor-set-in /tmp/mplang-descriptors.binpb \
            $proto_files

      - name: buf breaking
        if: github.event_name == 'pull_request'
        run: buf breaking --against "https://github.com/${{ github.repository }}.git#branch=main"

      - name: check critical lint steps's outcome
        if: always()
        run: |
          if [ ${{ steps.buf_lint.outcome }} != 'success' ]; then
            echo "buf lint failed"; exit 1;
          fi
          if [ ${{ steps.api_linter.outcome }} != 'success' ]; then
            echo "Google API Linter failed"; exit 1;
          fi
          echo "All critical lint steps passed."
